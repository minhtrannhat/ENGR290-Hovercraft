#include "init_290.h"


const uint16_t Servo_angle [256]={ //  +/-90 degrees
85,85,85,85,85,85,85,85,85,85,85,85,85,85,85,85, // 0...15
108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108, // 16...31 0.9ms pulse(108) 
119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119, // 32...47
131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131, // 48...63
142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142, // 64...79
154,154,154,154,154,154,154,154,154,154,154,154,154,154,154,154, // 80...95
165,165,165,165,165,165,165,165,165,165,165,165,165,165,165,165, // 96...111
177,177,177,177,177,177,177,177,177,177,177,177,188,188,188,188, // center - 1.5ms pulse (188) 112...127
188,188,188,188,198,198,198,198,198,198,198,198,198,198,198,198, // 128...143
208,208,208,208,208,208,208,208,208,208,208,208,208,208,208,208, // 143...159
218,218,218,218,218,218,218,218,218,218,218,218,218,218,218,218, // 160...175
228,228,228,228,228,228,228,228,228,228,228,228,228,228,228,228, // 175...191
238,238,238,238,238,238,238,238,238,238,238,238,238,238,238,238, // 192...207
248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248, // 208...223
270,270,270,270,270,270,270,270,270,270,270,270,270,270,270,270, // 224...239
290,290,290,290,290,290,290,290,290,290,290,290,290,290,290,290  // 240...255
};


inline void gpio_init() {
  cli();
  DDRB=((1<<PB4)|(1<<PB2)|(1<<PB1)|(1<<PB0)); 
  PORTB=((1<<PB3)|(1<<PB4)|(1<<PB5)); 
  
  DDRC=((1<<PC2)|(1<<PC1)); //|(1<<PC4); 
  PORTC=(1<<PC0); 

  DDRD=(1<<PD7)|(1<<PD6)|(1<<PD5)|(1<<PD4)|(1<<PD1); 
  PORTD=((1<<PD1)|(1<<PD2)|(1<<PD3)|(1<<PD4)|(1<<PD5)); 
  sei(); 
} //end gpio_init


inline void uart_tx_init() {
  UBRR0H = (uint8_t)((UBRR)>>8); 
  UBRR0L = (uint8_t)UBRR;
//  UCSR0B|=(1<<RXCIE0)|(1<<RXEN0); //uncomment if RX and RX IRQ are needed
  UCSR0B|=(1<<TXCIE0)|(1<<TXEN0); //(1<<UDRIE0)
  UCSR0C=(3<<UCSZ00); // NO PARITY
}// end UART init


// ======= PWM0 and PWM1 control (16-bit timer1) ===================
inline void timer1_50Hz_init(uint8_t en_IRQ) {
  TCCR1A|=(1<<COM1A1)|(1<<COM1B1); 
  TCCR1B|=(1<<WGM13);    
  ICR1=PWM_TOP; //50Hz PWM
  OCR1A=Servo_angle[127]; 
  OCR1B=0; 
  TCCR1B|=((1<<CS11)|(1<<CS10)); 
  if (en_IRQ) TIMSK1|=(1<<ICIE1);
}
 

inline void timer0_init () { 
// ======= PWM2 and D4 control (8-bit timer0) ===================
  TCCR0A|=(1<<COM0A1)|(1<<COM0B1)| (1<<COM0B0);  
  TCCR0A|=(1<<WGM00);              
  OCR0A=0; 
  OCR0B=255; 
  TCCR0B|=((1<<CS01)|(1<<CS00)); 
}


inline void adc_init (uint8_t channel, uint8_t en_IRQ) {
// ADC init
  ADMUX=((1<<ADLAR)|(1<<REFS0)|(channel&0x0F)); 
  ADCSRA=(1<<ADEN); 
  if (en_IRQ) ADCSRA|=(1<<ADIE); 
  ADCSRA|=(1<<ADPS0)|(1<<ADPS1)|(1<<ADPS2);
  ADCSRA|=(1<<ADATE); 
  ADCSRA|=(1<<ADSC);
}

inline void twi_init(){
// TWI init
TWSR=0; // no prescaler
TWBR=(uint8_t)(((F_CPU/SCL_CLOCK)-16)>>1);  //setting SCL; must be >10 for stable operation
}
